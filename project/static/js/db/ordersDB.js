import * as userDB from './userDB.js'
import * as productDB from './productDB.js'

const f = function(){

}
/*
get all orders from all users => getOrders();
get orders by userId => getOrders(userId);
get orders by sellerId => getOrders(null,sellerId);
get orders in specific user and sellerId => getOrders(userId,sellerId);
*/
export const get = async function(userId=null, sellerId=null){
    let allOrders = []; 
    let allProducts = await productDB.get();
    let users = await userDB.get(userId);
    for (const user of users) {
        let userOlders =user.orders;
        //fileter by sellerId if not null
        if(sellerId) userOlders = userOlders.filter(order=>order.sellerId == sellerId);
        for (const order of userOlders) {
            let product = allProducts.find(pr=>pr.id == order.productId && pr.sellerId == order.sellerId);
            let seller = users.find(us=>us.id == order.sellerId);
            allOrders.push(new Order(order.orderID, product.id, product.name, order.quantity, order.status, order.sellerId, seller.name,user.id,user.name));
        }
    }
    return allOrders;
}

const EditOrder =async function(order, method){
    //search for user
    let user = await userDB.getUserByOrderId(order.userId);
    if(user){
        //delete order
        if(method == 'd' || method == 'u')user.orders = user.orders.filter(or=>or !== order.id);
        
        if(method == 'u' || method == 'a') user.orders.push(order);
  
        await userDB.Update(user);
    }
}
export const add = async function(order){
    if(order instanceof Order)
        await EditOrder(order, 'a');
}

export const Update = async function(order){
    
    if(order instanceof Order)
        await EditOrder(order, 'u');
}

export const Delete = async function(order){
   
    if(order instanceof Order)
        await EditOrder(order, 'd');
}

export const getStatus = async function(){
    return ['pending', 'shipped', 'delivered', 'canceled'];
}

export class Order {
    id; //generated by server
    productId;
    productName;
    quantity;
    status;
    sellerId; //d
    sellerName; //d
    userId;
    userName; //d
    constructor(_id,_productId,_productName,_quantity,_status,_sellerId,_sellerName,_userId,_userName){
        this.id = _id == null?crypto.randomUUID():_id;
        this.productId = _productId;
        this.productName = _productName;
        this.quantity = _quantity;
        this.status = _status ==null?  getStatus()[0]: _status; //default status is pending
        this.sellerId = _sellerId;
        this.sellerName = _sellerName;
        this.userId = _userId;
        this.userName = _userName;
    }

}